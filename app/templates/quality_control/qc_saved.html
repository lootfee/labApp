{% extends "company_base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}


{% block app_content %}
{% include 'quality_control/qc_nav.html' %}
<hr class="inventory_hr">
<div class="row">
	<div class="col-md-12">
		<form action method="post" class="form" role="form">
			{{ form.csrf_token() }}
			<div class="col-md-4">
				{{ form.machine.label (class_="control-label")}}
				{{ form.machine (class_="form-control")}}
				<br>
				{{ form.control1.label (class_="control-label")}}
				{{ form.control1 (class_="form-control")}}
			</div>
			<div class="col-md-4">
				{{ form.analyte.label (class_="control-label")}}
				{{ form.analyte (class_="form-control")}}
				<br>
				{{ form.control2.label (class_="control-label")}}
				{{ form.control2 (class_="form-control")}}
			</div>
			<div class="col-md-4">
				{{ form.reagent_lot.label (class_="control-label")}}
				{{ form.reagent_lot (class_="form-control")}}
				<br>
				{{ form.control3.label (class_="control-label")}}
				{{ form.control3 (class_="form-control")}}
			</div>
			<div>
				<div class="col-md-3">
				<br>
					{{ form.start_date.label (class_="control-label")}}
					{{ form.start_date (class_="form-control")}}
				</div>
				<div class="col-md-3">
					<br>
					{{ form.end_date.label (class_="control-label")}}
					{{ form.end_date (class_="form-control")}}
				</div>
				<div class="col-md-6" style="margin-top:20px;">
					<br>
					{{ form.submit (class_="btn btn-default")}}
					<input id="calculate_meansd_btn" type="button" class="btn btn-default" value="Calculate Mean SD">
					<input id="create_chart_btn" type="button" class="btn btn-default" value="Create Chart">
				</div>	
			</div>	
			
			
		</form>
	</div>
</div>	
<div style="margin-top:20px;margin-bottom-20px">
	<br>
		{% if level3_data == True %}
		<div class="col-md-12">
			<div class="col-md-6">
				<div class="col-md-4">
					<label class="control-label">Control 1 Mean:</label>
					<input id="lvl1Mean" class="form-control decTostring" value="{{ qc_values.lvl1_mean }}" readonly>
					<br>
					<label class="control-label">Control 1 SD:</label>
					<input id="lvl1Stndev" class="form-control decTostring" value="{{ qc_values.lvl1_sd }}" readonly>
				</div>
				<div class="col-md-4">
					<label class="control-label">Control 2 Mean:</label>
					<input id="lvl2Mean" class="form-control decTostring" value="{{ qc_values.lvl2_mean }}" readonly>
					<br>
					<label class="control-label"> Control 2 SD:</label>
					<input id="lvl2Stndev" class="form-control decTostring" value="{{ qc_values.lvl2_sd }}" readonly>
				</div>
				<div class="col-md-4">
					<label class="control-label">Control 3 Mean:</label>
					<input id="lvl3Mean" class="form-control decTostring" value="{{ qc_values.lvl3_mean }}" readonly>
					<br>
					<label class="control-label"> Control 3 SD:</label>
					<input id="lvl3Stndev" class="form-control decTostring" value="{{ qc_values.lvl3_sd }}" readonly>
				</div>
			</div>
			<div class="col-md-6" id="calculted_mean_container">
				<div class="col-md-4">
					<label class="control-label">Control 1 Mean:</label>
					<input id="lvl1MeanCalc" class="form-control decTostring" readonly>
					<br>
					<label class="control-label">Control 1 SD:</label>
					<input id="lvl1StndevCalc" class="form-control decTostring" readonly>
				</div>
				<div class="col-md-4">
					<label class="control-label">Control 2 Mean:</label>
					<input id="lvl2MeanCalc" class="form-control decTostring" readonly>
					<br>
					<label class="control-label"> Control 2 SD:</label>
					<input id="lvl2StndevCalc" class="form-control decTostring" readonly>
				</div>
				<div class="col-md-4">
					<label class="control-label">Control 3 Mean:</label>
					<input id="lvl3MeanCalc" class="form-control decTostring"readonly>
					<br>
					<label class="control-label"> Control 3 SD:</label>
					<input id="lvl3StndevCalc" class="form-control " readonly>
				</div>
			</div>
		</div>
		<div class="col-md-12" style="margin-top:20px;margin-bottom-20px;;font-size:11px;>
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			<input class="col-md-1" value="Control 2" readonly>
			<input class="col-md-1" value="Control 3" readonly>
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			<input class="col-md-1" value="Control 2" readonly>
			<input class="col-md-1" value="Control 3" readonly>
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			<input class="col-md-1" value="Control 2" readonly>
			<input class="col-md-1" value="Control 3" readonly>
			
			{% for q in qc_res %}
			<input class="col-md-1 run_date_data" value="{{ q.run_date }}" readonly>
			<input class="col-md-1 decTostring control1_data" style="color:blue;" value="{{ q.lvl1 }}" readonly>
			<input class="col-md-1 decTostring control2_data" style="color:red;" value="{{ q.lvl2 }}" readonly>
			<input class="col-md-1 decTostring control3_data" style="color:yellow;" value="{{ q.lvl3 }}" readonly>
			{% endfor %}
		</div>
		
		{% elif level2_data == True %}
		<div class="col-md-12">
			<div class="col-md-6"> 
				<div class="col-md-4">
					<label class="control-label">Control 1 Mean:</label>
					<input id="lvl1Mean" class="form-control decTostring" value="{{ qc_values.lvl1_mean }}" readonly>
					<br>
					<label class="control-label">Control 1 SD:</label>
					<input id="lvl1Stndev" class="form-control decTostring" value="{{ qc_values.lvl1_sd }}" readonly>
				</div>
				<div class="col-md-4">
					<label class="control-label">Control 2 Mean:</label>
					<input id="lvl2Mean" class="form-control decTostring" value="{{ qc_values.lvl2_mean }}" readonly>
					<br>
					<label class="control-label"> Control 2 SD:</label>
					<input id="lvl2Stndev" class="form-control decTostring" value="{{ qc_values.lvl2_sd }}" readonly>
				</div>
			</div>
			<div class="col-md-6" id="calculted_mean_container">
				<div class="col-md-4">
					<label class="control-label">Control 1 Mean:</label>
					<input id="lvl1MeanCalc" class="form-control decTostring" readonly>
					<br>
					<label class="control-label">Control 1 SD:</label>
					<input id="lvl1StndevCalc" class="form-control decTostring" readonly>
				</div>
				<div class="col-md-4">
					<label class="control-label">Control 2 Mean:</label>
					<input id="lvl2MeanCalc" class="form-control decTostring" readonly>
					<br>
					<label class="control-label"> Control 2 SD:</label>
					<input id="lvl2StndevCalc" class="form-control decTostring" readonly>
				</div>
			</div>
		</div>
		<div class="col-md-12" style="margin-top:20px;margin-bottom-20px;;font-size:11px;">
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			<input class="col-md-1" value="Control 2" readonly>
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			<input class="col-md-1" value="Control 2" readonly>
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			<input class="col-md-1" value="Control 2" readonly>
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			<input class="col-md-1" value="Control 2" readonly>
			
			{% for q in qc_res %}
			<input class="col-md-1 run_date_data" value="{{ q.run_date }}" readonly>
			<input class="col-md-1 control1_data decTostring" style="color:blue;" value="{{ q.lvl1 }}" readonly>
			<input class="col-md-1 control2_data decTostring" style="color:red;" value="{{ q.lvl2 }}" readonly>
			{% endfor %}
		</div>
		{% elif level1_data == True %}
		<div class="col-md-12">
			<div class="col-md-6">
				<div class="col-md-4">
					<label class="control-label">Control 1 Mean:</label>
					<input id="lvl1Mean" class="form-control decTostring" value="{{ qc_values.lvl1_mean }}" readonly>
					<br>
					<label class="control-label"> Control 1 SD:</label>
					<input id="lvl1Stndev" class="form-control decTostring" value="{{ qc_values.lvl1_sd }}" readonly>
				</div>
			</div>
			<div class="col-md-6" id="calculted_mean_container">
				<div class="col-md-4">
					<label class="control-label">Control 1 Mean:</label>
					<input id="lvl1MeanCalc" class="form-control decTostring" readonly>
					<br>
					<label class="control-label">Control 1 SD:</label>
					<input id="lvl1StndevCalc" class="form-control decTostring" readonly>
				</div>
			</div>
		</div>
		<div class="col-md-12" style="margin-top:20px;margin-bottom-20px;;font-size:11px;">
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			<input class="col-md-1" value="Run Date" readonly>
			<input class="col-md-1" value="Control 1" readonly>
			
			{% for q in qc_res %}
			<input class="col-md-1 run_date_data" value="{{ q.run_date }}" readonly>
			<input class="col-md-1 control1_data decTostring" style="color:blue;" value="{{ q.lvl1 }}" readonly>
			{% endfor %}
		</div>
		{% endif %}
</div>

<div class="container-fluid">
	<div class="row text-center">
		<div class="col-md-12 chart-container text-center" id="chartContainer">
			<canvas id="chartjs" ></canvas>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<label>Comments:</label>
			<textarea class="form-control" rows="3"></textarea>
		</div>
	</div>
</div>
<div class="container-fluid visible-print-block">
	<div class="row">
		<div class="col-md-6">
			<p>Generated by: {{ user.firstname }} {{ user.lastname }}</p>
			<p>Date: {{ moment().format('LLLL') }}. </p>
		</div>
	</div>
</div>

{% endblock %}


{% block styles %}
{{ super() }}
<style>
#chartContainer {
	position: relative;
	--border: 2px solid #ddd;
	margin-left: 1em;
	margin-right: auto;
	display: block;
	width: 100%;
	border-radius: 8px;
}
@media print {
	body {
		font-size: 10px;
	}

	.no_print {
		display: none;
	}
	#qc_title {
		margin-top: 40px;
	}
	
	.col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12 {
        float: left;
   }
   .col-md-12 {
        width: 100%;
   }
   .col-md-11 {
        width: 91.66666667%;
   }
   .col-md-10 {
        width: 83.33333333%;
   }
   .col-md-9 {
        width: 75%;
   }
   .col-md-8 {
        width: 66.66666667%;
   }
   .col-md-7 {
        width: 58.33333333%;
   }
   .col-md-6 {
        width: 50%;
   }
   .col-md-5 {
        width: 41.66666667%;
   }
   .col-md-4 {
        width: 33.33333333%;
   }
   .col-md-3 {
        width: 25%;
   }
   .col-md-2 {
        width: 16.66666667%;
   }
   .col-md-1 {
        width: 8.33333333%;
   }
   
   #chartContainer {
		position: relative;
		width: 90%;
		margin-left: 5vw;
		margin-right: auto;
	}
	
	#chartjs {
		padding-left: 0;
		padding-right: 0;
		margin-left: auto;
		margin-right: auto;
		display: block;
		width: 80%;
	}
	
	.qcImportData1 {
		color: blue;
	}

	.qcImportData2 {
		color: red;
	}

	.qcImportData3 {
		color: #cccc0e;
	}
}

#calculted_mean_container {
	display: none;
}
</style>
{% endblock %}
{% block scripts %}
{{ super() }}
<!--script src="{{url_for('static', filename='js/qc.js')}}"></script-->
<script>
google.charts.load('current', {'packages':['line', 'corechart']});

$(document).ready(function() {
	$(".decTostring").each(function() {
		$(this).val(parseFloat($(this).val()));
	});
	function decimalPlaces(num) {
		let match = (''+num).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);
		if (!match) { return 0; }
		return Math.max(
		   0,
		   // Number of digits right of decimal point.
		   (match[1] ? match[1].length : 0)
		   // Adjust for scientific notation.
		   - (match[2] ? +match[2] : 0));
	}
	
	function N(id, places) { 
		return +(Math.round(id + "e+" + places)  + "e-" + places);
	}
	
	$("#calculate_meansd_btn").click(function() {
		//control 1
		var sum1 = 0;
		var totSqrd1 = 0;
		var x1 = 0;
		var n1 = $(".control1_data").length;
		$(".control1_data").each(function(){
			sum1 += parseFloat($(this).val());
			if (decimalPlaces($(".control1_data").val()) > x1){
					y = $(".control1_data").val();
					x1 = decimalPlaces(y);
				}
		});
		var dp1 = x1;
		var mean1 = sum1/n1;
		$(".control1_data").each(function(i){
			if ($(".control1_data").val()!= ''){
				totSqrd1 += (parseFloat($(this).val()) - mean1) * (parseFloat($(this).val()) - mean1);
			}
		});
		var variance1 = totSqrd1 / (n1 - 1);
		
		var sd1 = Math.sqrt(variance1);
		var cv1 = parseFloat(sd1 / mean1) * 100;
		mean1 = N(mean1, dp1);
		sd1 = N(sd1, dp1);
		cv1 = N(cv1, dp1);
		$("#lvl1MeanCalc").val(mean1);
		$("#lvl1StndevCalc").val(sd1);
		//control 2
		var sum2 = 0;
		var totSqrd2 = 0;
		var x2 = 0;
		var n2 = $(".control2_data").length;
		$(".control2_data").each(function(){
			sum2 += parseFloat($(this).val());
			if (decimalPlaces($(".control2_data").val()) > x2){
					y = $(".control2_data").val();
					x2 = decimalPlaces(y);
				}
		});
		var dp2 = x2;
		var mean2 = sum2/n2;
		$(".control2_data").each(function(i){
			if ($(".control2_data").val()!= ''){
				totSqrd2 += (parseFloat($(this).val()) - mean2) * (parseFloat($(this).val()) - mean2);
			}
		});
		var variance2 = totSqrd2 / (n2 - 1);
		var sd2 = Math.sqrt(variance2);
		var cv2 = parseFloat(sd2 / mean2) * 100;
		mean2 = N(mean2, dp2);
		sd2 = N(sd2, dp2);
		cv2 = N(cv2, dp2);
		$("#lvl2MeanCalc").val(mean2);
		$("#lvl2StndevCalc").val(sd2);
		
		//control 3
		var sum3 = 0;
		var totSqrd3 = 0;
		var x3 = 0;
		var n3 = $(".control3_data").length;
		$(".control3_data").each(function(){
			sum3 += parseFloat($(this).val());
			if (decimalPlaces($(".control3_data").val()) > x3){
					y = $(".control3_data").val();
					x3 = decimalPlaces(y);
				}
		});
		var dp3 = x3;
		var mean3 = sum3/n3;
		$(".control3_data").each(function(i){
			if ($(".control3_data").val()!= ''){
				totSqrd3 += (parseFloat($(this).val()) - mean3) * (parseFloat($(this).val()) - mean3);
			}
		});
		var variance3 = totSqrd3 / (n3 - 1);
		var sd3 = Math.sqrt(variance3);
		var cv3 = parseFloat(sd3 / mean3) * 100;
		mean3 = N(mean3, dp3);
		sd3 = N(sd3, dp3);
		cv3 = N(cv3, dp3);
		$("#lvl3MeanCalc").val(mean3);
		$("#lvl3StndevCalc").val(sd3);
		
		$("#calculted_mean_container").css('display', 'block');
	});
});


//----for lj chart
$("#create_chart_btn").click(function(){
	var ctx = document.getElementById('chartContainer');
	var ctrl1_mean = $("#lvl1Mean").val()
	var ctrl2_mean = $("#lvl2Mean").val()
	var ctrl3_mean = $("#lvl3Mean").val()
	var ctrl1_stdv = $("#lvl1Stndev").val()
	var ctrl2_stdv = $("#lvl2Stndev").val()
	var ctrl3_stdv = $("#lvl3Stndev").val()
	var arr1 = [];
	var arr2 = [];
	var arr3 = [];
	var arrD = [];
	var run_date = document.getElementsByClassName('run_date_data');
	
	var control1_data = document.getElementsByClassName('control1_data');
	var control2_data = document.getElementsByClassName('control2_data');
	var control3_data = document.getElementsByClassName('control3_data');
	
	var p3sd1 = parseFloat(+ctrl1_mean + +(ctrl1_stdv*3));
	var p2sd1= parseFloat(+ctrl1_mean + +(ctrl1_stdv*2));
	var p1sd1 = parseFloat(+ctrl1_mean + +ctrl1_stdv);
	var n1sd1 = parseFloat(ctrl1_mean - ctrl1_stdv);
	var n2sd1 = parseFloat(ctrl1_mean - ctrl1_stdv*2);
	var n3sd1 = parseFloat(ctrl1_mean - ctrl1_stdv*3);
	
	var p3sd2 = parseFloat(+ctrl2_mean + +(ctrl2_stdv*3));
	var p2sd2 = parseFloat(+ctrl2_mean + +(ctrl2_stdv*2));
	var p1sd2 = parseFloat(+ctrl2_mean + +ctrl2_stdv);
	var n1sd2 = parseFloat(ctrl2_mean - ctrl2_stdv);
	var n2sd2 = parseFloat(ctrl2_mean - ctrl2_stdv*2);
	var n3sd2 = parseFloat(ctrl2_mean - ctrl2_stdv*3);
	
	var p3sd3 = parseFloat(+ctrl3_mean + +(ctrl3_stdv*3));
	var p2sd3 = parseFloat(+ctrl3_mean + +(ctrl3_stdv*2));
	var p1sd3 = parseFloat(+ctrl3_mean + +ctrl3_stdv);
	var n1sd3 = parseFloat(ctrl3_mean - ctrl3_stdv);
	var n2sd3 = parseFloat(ctrl3_mean - ctrl3_stdv*2);
	var n3sd3 = parseFloat(ctrl3_mean - ctrl3_stdv*3);
	
	var data = new google.visualization.DataTable();
	data.addColumn('string', "Run Date");
	data.addColumn('number', "Lvl 1");
	data.addColumn({type: 'string', role: 'annotation'});
	data.addColumn('number', "Lvl 2");
	data.addColumn({type: 'string', role: 'annotation'});
	data.addColumn('number', "Lvl 3");
	data.addColumn({type: 'string', role: 'annotation'});
	
	for (var i=0;i<run_date.length;i++) {
	
		if (run_date.length > 0){
			arrD.push(run_date[i].value.toString());
		}
		if (control1_data.length > 0){
			arr1.push(control1_data[i].value);
		}
		if (control2_data.length > 0){
			arr2.push(control2_data[i].value);
		}
		if (control3_data.length > 0){
			arr3.push(control3_data[i].value);
		}
		data.addRows([
			[(arrD[i]), parseFloat(arr1[i]), arr1[i], parseFloat(arr2[i]), arr2[i], parseFloat(arr3[i]), arr3[i]]
			
		]);
		
	}
	
	var options = {
				title: '',
				width: 1000,
				height: 400,
				interpolateNulls: true,
				series: {
					0: {targetAxisIndex: 0},
					1: {targetAxisIndex: 1},
					2: {targetAxisIndex: 2}
				},
				vAxes: {
					0: {title: '',
						baseline: ctrl1_mean,
						ticks: [{v: p3sd1, f: '+3sd'}, {v: p2sd1, f: '+2sd'}, {v: p1sd1, f: '+1sd'}, {v: ctrl1_mean, f: 'mean'}, {v: n1sd1, f: '-1sd'}, {v: n2sd1, f: '-2sd'}, {v: n3sd1, f: '-3sd'}],
						/*minValue: n3sd1,
						maxValue: p3sd1,*/
						//viewWindowMode: 'maximized',
						viewWindow: {
							max: p3sd1,
							min: n3sd1
						}
					},
					1: {title: '',
						baseline: ctrl2_mean,
						ticks: [{v: p3sd2, f: ''}, {v: p2sd2, f: ''}, {v: p1sd2, f: ''}, {v: ctrl2_mean, f: ''}, {v: n1sd2, f: ''}, {v: n2sd2, f: ''}, {v: n3sd2, f: ''}],
						/*minValue: n3sd2,
						maxValue: p3sd2,*/
						//viewWindowMode: 'maximized',
						viewWindow: {
							max: p3sd2,
							min: n3sd2,
						}
					},
					2: {title: '',
						baseline: ctrl3_mean,
						ticks: [{v: p3sd3, f: ''}, {v: p2sd3, f: ''}, {v: p1sd3, f: ''}, {v: ctrl3_mean, f: ''}, {v: n1sd3, f: ''}, {v: n2sd3, f: ''}, {v: n3sd3, f: ''}],
						/*minValue: n3sd3,
						maxValue: p3sd3,*/
						//viewWindowMode: 'maximized',
						viewWindow: {
							max: p3sd3,
							min: n3sd3,
						}
					}
				},
				chartArea:{
					top: '10%',
					width:'80%',
					height:'75%'
				},
				hAxis: {
					ticks: run_date,
					textStyle: {
						fontSize: 9
					},
				},			
				/*vAxis: {
					viewWindowMode: 'maximized',
				},	*/					
				pointSize: 5,
				annotations: {
					textStyle: {
					  fontSize: 7,
					  bold: false,
					  opacity: 0.0,
					},
					stem : {
						color: "white",
					}
				},
				logScale: false,
			};
	var chart = new google.visualization.LineChart(ctx);
    chart.draw(data, options);
});
</script>
{% endblock %}