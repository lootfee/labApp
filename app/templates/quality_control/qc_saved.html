{% extends "company_base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}


{% block app_content %}
{% include 'quality_control/qc_nav.html' %}
<hr class="inventory_hr">
<div class="row">
	<div class="col-md-12 visible-print-block">
		<div class="col-md-3">
			{% if company.logo %}
			<div width="180px"><img src="{{ company.logo }}" alt="{{ company.company_name }}" style="width:180px;height:150px;"></div>
			{% else %}
			<div width="180px"><img src="{{ company.company_avatar(150) }}"></div>
			{% endif %}
		</div>
		<div class="col-md-6 text-center" >
			<h1>{{ company.company_name }}</h1>
		</div>
		<div class="col-md-3" style="height:150px;">
			<div style="bottom:0;">
				<p>Address: {{ company.address }}</p>
				<p>Email: {{ company.email }}</p>
				<p>Contact: {{ company.contact_info }}</p>
			</div>
		</div>
	</div>
</div>
<br>
<div class="row">
	<div class="col-md-12">
		<!--div class="row">
			<div class="col-md-12" id="qc_title">
				<input type="text" class="form-control qc-info text-center" style="font-size: 15px; font-weight: bold;" placeholder="Title">
			</div>
		</div-->
		<br>
		<form action method="post" class="form" role="form">
			{{ form.csrf_token() }}
			<div class="col-md-4">
				{{ form.qcrf_machine.label (class_="control-label")}}
				{{ form.qcrf_machine (class_="form-control")}}
				<br>
				{{ form.control1.label (class_="control-label")}}
				{{ form.control1 (class_="form-control")}}
			</div>
			<div class="col-md-4">
				{{ form.qcrf_analyte.label (class_="control-label")}}
				{{ form.qcrf_analyte (class_="form-control")}}
				<br>
				{{ form.control2.label (class_="control-label")}}
				{{ form.control2 (class_="form-control")}}
			</div>
			<div class="col-md-4">
				{{ form.qcrf_reagent_lot.label (class_="control-label")}}
				{{ form.qcrf_reagent_lot (class_="form-control")}}
				<br>
				{{ form.control3.label (class_="control-label")}}
				{{ form.control3 (class_="form-control")}}
			</div>
			<div>
				<div class="col-md-3">
				<br>
					{{ form.start_date.label (class_="control-label")}}
					{{ form.start_date (class_="form-control")}}
				</div>
				<div class="col-md-3">
					<br>
					{{ form.end_date.label (class_="control-label")}}
					{{ form.end_date (class_="form-control")}}
				</div>
				<div class="col-md-6" style="margin-top:20px;">
					<br>
					{{ form.qcrf_submit (class_="btn btn-default")}}
					<!--input id="calculate_meansd_btn" type="button" class="btn btn-default no_print" value="Calculate Mean SD">
					<input id="create_chart_btn" type="button" class="btn btn-default no_print" value="Create Chart"-->
				</div>	
			</div>	
			
			
		</form>
	</div>
</div>	

{% endblock %}


{% block styles %}
{{ super() }}
<style>

</style>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>

$(document).ready(function() {
	
	$('select#qcrf_machine option').addClass(function() {
		{% for ma in machine_analyte_link %}
			return this.value;
		{% endfor %}
		
	});
	
	//    for updating select options   
	
	 $SCRIPT_ROOT = {{ request.script_root|tojson|safe }}; //same like url_for ut for jquery
	
		
	$('#qcrf_machine').change(function(){
		$('#qcrf_analyte').empty();
		$.getJSON($SCRIPT_ROOT + '/update_analyte_list', {
			company_id : {{ company.id }}, 
			machine_id : $(this).val()
		}, function(data){
			$.each(data.result, function(i, new_options){
				$('#qcrf_analyte').append($('<option></option>').attr("value", new_options[0]).text(new_options[1]) );
			})
			
		});
		return false;
	});
	
	$('#qcrf_analyte').change(function(){
		$('#qcrf_reagent_lot').empty();
		$.getJSON($SCRIPT_ROOT + '/update_rlot_list', {
			company_id : {{ company.id }}, 
			analyte_id : $(this).val()
		}, function(data){
			$.each(data.result, function(i, new_options){
				$('#qcrf_reagent_lot').append($('<option></option>').attr("value", new_options[0]).text(new_options[1]) );
			})
		});
		$('#control1').empty();
		$.getJSON($SCRIPT_ROOT + '/update_control_lot_list', {
			machine_id : $('#qcrf_machine').val(), 
			company_id : {{ company.id }}, 
			analyte_id : $(this).val(),
			rlot_id : "0"
		}, function(data){
			$.each(data.result, function(i, new_options){
				$('#control1').append($('<option></option>').attr("value", new_options[0]).text(new_options[1]) );
			})
			
		});
		$('#control2').empty();
		$.getJSON($SCRIPT_ROOT + '/update_control_lot_list', {
			machine_id : $('#qcrf_machine').val(), 
			company_id : {{ company.id }}, 
			analyte_id : $(this).val(),
			rlot_id : "0"
		}, function(data){
			$.each(data.result, function(i, new_options){
				$('#control2').append($('<option></option>').attr("value", new_options[0]).text(new_options[1]) );
			})
			
		});
		$('#control3').empty();
		$.getJSON($SCRIPT_ROOT + '/update_control_lot_list', {
			machine_id : $('#qcrf_machine').val(), 
			company_id : {{ company.id }}, 
			analyte_id : $(this).val(),
			rlot_id : "0"
		}, function(data){
			$.each(data.result, function(i, new_options){
				$('#control3').append($('<option></option>').attr("value", new_options[0]).text(new_options[1]) );
			})
			
		});
		return false;
	});
	
	$('#qcrf_reagent_lot').change(function(){
		/*$('#eqcrf_control').empty();
		$.getJSON($SCRIPT_ROOT + '/update_control_list', {
			company_id : {{ company.id }}, 
			analyte_id : $('#eqcrf_analyte').val(),
			machine_id : $('#eqcrf_machine').val(), 
			rlot_id : $(this).val()
		}, function(data){
			$.each(data.result, function(i, new_options){
				$('#eqcrf_control').append($('<option></option>').attr("value", new_options[0]).text(new_options[1]) );
			})
		});*/
		
		$('#control1').empty();
		$.getJSON($SCRIPT_ROOT + '/update_control_lot_list', {
			company_id : {{ company.id }}, 
			analyte_id : $('#qcrf_analyte').val(),
			machine_id : $('#qcrf_machine').val(), 
			rlot_id : $(this).val()
		}, function(data){
			$.each(data.result, function(i, new_options){
				$('#control1').append($('<option></option>').attr("value", new_options[0]).text(new_options[1]) );
			})
			
		});
		$('#control2').empty();
		$.getJSON($SCRIPT_ROOT + '/update_control_lot_list', {
			company_id : {{ company.id }}, 
			analyte_id : $('#qcrf_analyte').val(),
			machine_id : $('#qcrf_machine').val(), 
			rlot_id : $(this).val()
		}, function(data){
			$.each(data.result, function(i, new_options){
				$('#control2').append($('<option></option>').attr("value", new_options[0]).text(new_options[1]) );
			})
			
		});
		$('#control3').empty();
		$.getJSON($SCRIPT_ROOT + '/update_control_lot_list', {
			company_id : {{ company.id }}, 
			analyte_id : $('#qcrf_analyte').val(),
			machine_id : $('#qcrf_machine').val(), 
			rlot_id : $(this).val()
		}, function(data){
			$.each(data.result, function(i, new_options){
				$('#control3').append($('<option></option>').attr("value", new_options[0]).text(new_options[1]) );
			})
			
		});
				
		return false;
	});
});
/*
$(document).ready(function() {
	$(".decTostring").each(function() {
		$(this).val(parseFloat($(this).val()));
	});
	
	function N(id, places) { 
		return +(Math.round(id + "e+" + places)  + "e-" + places);
	}
	
	function decimalPlaces(num) {
		let match = (''+num).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);
		if (!match) { return 0; }
		return Math.max(
		   0,
		   // Number of digits right of decimal point.
		   (match[1] ? match[1].length : 0)
		   // Adjust for scientific notation.
		   - (match[2] ? +match[2] : 0));
	}
	
	$("#calculate_meansd_btn").click(function() {
		//control 1
		var sum1 = 0;
		var totSqrd1 = 0;
		var x1 = 0;
		var n1 = 0//$(".control1_data").length;
		$(".control1_data").each(function(){
			if ($(this).val() != ""){
				n1 += 1
				
				sum1 += parseFloat($(this).val());
				if (decimalPlaces($(this).val()) > x1){
						y = $(this).val();
						x1 = decimalPlaces(y);
					}
			}
			
		});
		console.log(sum1)
		var dp1 = x1;
		var mean1 = sum1/n1;
		$(".control1_data").each(function(i){
			if ($(this).val() != ''){
				totSqrd1 += (parseFloat($(this).val()) - mean1) * (parseFloat($(this).val()) - mean1);
			}
		});
		
		var variance1 = totSqrd1 / (n1 - 1);
		var sd1 = Math.sqrt(variance1);
		var cv1 = parseFloat(sd1 / mean1) * 100;
		mean1 = N(mean1, dp1);
		sd1 = N(sd1, dp1);
		cv1 = N(cv1, dp1);
		$("#lvl1MeanCalc").val(mean1);
		$("#lvl1StndevCalc").val(sd1);
		$("#lvl1CVCalc").val(cv1)
		
		//control 2
		var sum2 = 0;
		var totSqrd2 = 0;
		var x2 = 0;
		var n2 = 0//$(".control2_data").length;
		$(".control2_data").each(function(){
			if ($(this).val() != ""){
				n2 += 1
				
				sum2 += parseFloat($(this).val());
				if (decimalPlaces($(".control2_data").val()) > x2){
						y = $(".control2_data").val();
						x2 = decimalPlaces(y);
					}
			}
			
		});
		var dp2 = x2;
		var mean2 = sum2/n2;
		$(".control2_data").each(function(i){
			if ( $(this).val() !=  ''){
				totSqrd2 += (parseFloat($(this).val()) - mean2) * (parseFloat($(this).val()) - mean2);
			}
		});
		
		var variance2 = totSqrd2 / (n2 - 1);
		var sd2 = Math.sqrt(variance2);
		var cv2 = parseFloat(sd2 / mean2) * 100;
		mean2 = N(mean2, dp2);
		sd2 = N(sd2, dp2);
		cv2 = N(cv2, dp2);
		$("#lvl2MeanCalc").val(mean2);
		$("#lvl2StndevCalc").val(sd2);
		$("#lvl2CVCalc").val(cv2)
		
		//control 3
		var sum3 = 0;
		var totSqrd3 = 0;
		var x3 = 0;
		var n3 = 0//$(".control3_data").length;
		$(".control3_data").each(function(){
			if ($(this).val() !=  ""){
				n3 += 1
				
				sum3 += parseFloat($(this).val());
				if (decimalPlaces($(this).val()) > x3){
						y = $(this).val()
						x3 = decimalPlaces(y);
					}
			}
			
		});
		var dp3 = x3;
		var mean3 = sum3/n3;
		$(".control3_data").each(function(i){
			if ($(this).val() !=  ''){
				totSqrd3 += (parseFloat($(this).val()) - mean3) * (parseFloat($(this).val()) - mean3);
			}
		});
		var variance3 = totSqrd3 / (n3 - 1);
		var sd3 = Math.sqrt(variance3);
		var cv3 = parseFloat(sd3 / mean3) * 100;
		mean3 = N(mean3, dp3);
		sd3 = N(sd3, dp3);
		cv3 = N(cv3, dp3);
		$("#lvl3MeanCalc").val(mean3);
		$("#lvl3StndevCalc").val(sd3);
		$("#lvl3CVCalc").val(cv3)
		
		$("#calculted_mean_container").css('display', 'block');
	});
});


//----for lj chart
$("#create_chart_btn").click(function(){
	var ctx = document.getElementById('chartContainer');
	var gbtn = document.getElementById("use_calc_values").checked//$("#use_calc_values").checked;
	var ctrl1_mean = $("#lvl1Mean").val();
	var ctrl2_mean = $("#lvl2Mean").val();
	var ctrl3_mean = $("#lvl3Mean").val();
	var ctrl1_stdv = $("#lvl1Stndev").val();
	var ctrl2_stdv = $("#lvl2Stndev").val();
	var ctrl3_stdv = $("#lvl3Stndev").val();
	
	if (gbtn == true) {
		ctrl1_mean = $("#lvl1MeanCalc").val();
		ctrl2_mean = $("#lvl2MeanCalc").val();
		ctrl3_mean = $("#lvl3MeanCalc").val();
		ctrl1_stdv = $("#lvl1StndevCalc").val();
		ctrl2_stdv = $("#lvl2StndevCalc").val();
		ctrl3_stdv = $("#lvl3StndevCalc").val();
	}
	
	
	var arr1 = [];
	var arr2 = [];
	var arr3 = [];
	var arrD = [];
	var run_date = document.getElementsByClassName('run_date_data');
	
	var control1_data = document.getElementsByClassName('control1_data');
	var control2_data = document.getElementsByClassName('control2_data');
	var control3_data = document.getElementsByClassName('control3_data');
	
	var p3sd1 = parseFloat(+ctrl1_mean + +(ctrl1_stdv*3));
	var p2sd1= parseFloat(+ctrl1_mean + +(ctrl1_stdv*2));
	var p1sd1 = parseFloat(+ctrl1_mean + +ctrl1_stdv);
	var n1sd1 = parseFloat(ctrl1_mean - ctrl1_stdv);
	var n2sd1 = parseFloat(ctrl1_mean - ctrl1_stdv*2);
	var n3sd1 = parseFloat(ctrl1_mean - ctrl1_stdv*3);
	
	var p3sd2 = parseFloat(+ctrl2_mean + +(ctrl2_stdv*3));
	var p2sd2 = parseFloat(+ctrl2_mean + +(ctrl2_stdv*2));
	var p1sd2 = parseFloat(+ctrl2_mean + +ctrl2_stdv);
	var n1sd2 = parseFloat(ctrl2_mean - ctrl2_stdv);
	var n2sd2 = parseFloat(ctrl2_mean - ctrl2_stdv*2);
	var n3sd2 = parseFloat(ctrl2_mean - ctrl2_stdv*3);
	
	var p3sd3 = parseFloat(+ctrl3_mean + +(ctrl3_stdv*3));
	var p2sd3 = parseFloat(+ctrl3_mean + +(ctrl3_stdv*2));
	var p1sd3 = parseFloat(+ctrl3_mean + +ctrl3_stdv);
	var n1sd3 = parseFloat(ctrl3_mean - ctrl3_stdv);
	var n2sd3 = parseFloat(ctrl3_mean - ctrl3_stdv*2);
	var n3sd3 = parseFloat(ctrl3_mean - ctrl3_stdv*3);
	
	var data = new google.visualization.DataTable();
	data.addColumn('string', "Run Date");
	data.addColumn('number', "Lvl 1");
	data.addColumn({type: 'string', role: 'annotation'});
	data.addColumn('number', "Lvl 2");
	data.addColumn({type: 'string', role: 'annotation'});
	data.addColumn('number', "Lvl 3");
	data.addColumn({type: 'string', role: 'annotation'});
	
	for (var i=0;i<run_date.length;i++) {
	
		if (run_date.length > 0){
			arrD.push(run_date[i].value.toString());
		}
		if (control1_data.length > 0){
			arr1.push(control1_data[i].value);
		}
		if (control2_data.length > 0){
			arr2.push(control2_data[i].value);
		}
		if (control3_data.length > 0){
			arr3.push(control3_data[i].value);
		}
		data.addRows([
			[(arrD[i]), parseFloat(arr1[i]), arr1[i], parseFloat(arr2[i]), arr2[i], parseFloat(arr3[i]), arr3[i]]
			
		]);
		
	}
	
	var options = {
				title: '',
				width: 1000,
				height: 400,
				interpolateNulls: true,
				series: {
					0: {targetAxisIndex: 0},
					1: {targetAxisIndex: 1},
					2: {targetAxisIndex: 2}
				},
				vAxes: {
					0: {title: '',
						baseline: ctrl1_mean,
						ticks: [{v: p3sd1, f: '+3sd'}, {v: p2sd1, f: '+2sd'}, {v: p1sd1, f: '+1sd'}, {v: ctrl1_mean, f: 'mean'}, {v: n1sd1, f: '-1sd'}, {v: n2sd1, f: '-2sd'}, {v: n3sd1, f: '-3sd'}],
						//minValue: n3sd1,
						//maxValue: p3sd1,
						//viewWindowMode: 'maximized',
						viewWindow: {
							max: p3sd1,
							min: n3sd1
						}
					},
					1: {title: '',
						baseline: ctrl2_mean,
						ticks: [{v: p3sd2, f: ''}, {v: p2sd2, f: ''}, {v: p1sd2, f: ''}, {v: ctrl2_mean, f: ''}, {v: n1sd2, f: ''}, {v: n2sd2, f: ''}, {v: n3sd2, f: ''}],
						//minValue: n3sd2,
						//maxValue: p3sd2,
						//viewWindowMode: 'maximized',
						viewWindow: {
							max: p3sd2,
							min: n3sd2,
						}
					},
					2: {title: '',
						baseline: ctrl3_mean,
						ticks: [{v: p3sd3, f: ''}, {v: p2sd3, f: ''}, {v: p1sd3, f: ''}, {v: ctrl3_mean, f: ''}, {v: n1sd3, f: ''}, {v: n2sd3, f: ''}, {v: n3sd3, f: ''}],
						//minValue: n3sd3,
						//maxValue: p3sd3,
						//viewWindowMode: 'maximized',
						viewWindow: {
							max: p3sd3,
							min: n3sd3,
						}
					}
				},
				chartArea:{
					top: '10%',
					width:'80%',
					height:'75%'
				},
				hAxis: {
					ticks: run_date,
					textStyle: {
						fontSize: 9
					},
				},			
				//vAxis: {
				//	viewWindowMode: 'maximized',
				//},					
				pointSize: 5,
				annotations: {
					textStyle: {
					  fontSize: 7,
					  bold: false,
					  opacity: 0.0,
					},
					stem : {
						color: "white",
					}
				},
				logScale: false,
			};
	var chart = new google.visualization.LineChart(ctx);
    chart.draw(data, options);
});


$(document).ready(function() {
//calculated given values cv	
	function N(id, places) { 
		return +(Math.round(id + "e+" + places)  + "e-" + places);
	}
	
	function decimalPlaces(num) {
		let match = (''+num).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);
		if (!match) { return 0; }
		return Math.max(
		   0,
		   // Number of digits right of decimal point.
		   (match[1] ? match[1].length : 0)
		   // Adjust for scientific notation.
		   - (match[2] ? +match[2] : 0));
	}
	
	//control 1
	var x1 = 0;
	var z1 = $("#lvl1Mean").val();
	if (decimalPlaces($("#lvl1Stndev").val()) > decimalPlaces(z1)){
		z1 = $("#lvl1Stndev").val();
	}
	if (decimalPlaces(z1) > x1){
		y1 = z1;
		x1 = decimalPlaces(y1);
	}
	dp1 = x1
	var cv1 = parseFloat(($("#lvl1Stndev").val() / $("#lvl1Mean").val()) * 100);
	cv1 = N(cv1, dp1);
	$("#lvl1CV").val(cv1);
	
	//control 2
	var x2 = 0;
	var z2 = $("#lvl2Mean").val();
	if (decimalPlaces($("#lvl2Stndev").val()) > decimalPlaces(z2)){
		z2 = $("#lvl2Stndev").val();
	}
	if (decimalPlaces(z2) > x2){
		y2 = z2;
		x2 = decimalPlaces(y2);
	}
	dp2 = x2
	var cv2 = parseFloat(($("#lvl2Stndev").val() / $("#lvl2Mean").val()) * 100);
	cv2 = N(cv2, dp2);
	$("#lvl2CV").val(cv2);
	
	//control 3
	var x3 = 0;
	var z3 = $("#lvl3Mean").val();
	if (decimalPlaces($("#lvl3Stndev").val()) > decimalPlaces(z3)){
		z3 = $("#lvl3Stndev").val();
	}
	if (decimalPlaces(z3) > x3){
		y3 = z3;
		x3 = decimalPlaces(y3);
	}
	dp3 = x3
	var cv3 = parseFloat(($("#lvl3Stndev").val() / $("#lvl3Mean").val()) * 100);
	cv3 = N(cv3, dp3);
	$("#lvl3CV").val(cv3);
});*/
</script>
{% endblock %}