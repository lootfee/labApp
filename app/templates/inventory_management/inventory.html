{% extends "company_base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block app_content %}
{% include 'inventory_management/inventory_manager_nav.html' %}	
    <h3 class="inventory_headers">Current Inventory</h3>
	<hr class="inventory_hr">
    <div class="row">
		<div class="col-md-12 registerContainer" id="create_orders_form_container" >
			<div class="col-md-5" style="margin-bottom: 10px;">
				<div class="col-md-6">
					<label class="control-label" for="search_create_orders">Search</label>
					<input class="form-control" id="search_create_orders">
				</div>
				<div class="col-md-6">
					<label class="control-label" for="department">Department</label>
					<select class="form-control" id="department">
						<option value=''>All</option>
						{% for d in dept %}
						<option value='{{ d.name }}'>{{ d.name }}</option>
						{% endfor %}
					</select>
				</div>
			</div>
			<table class="sort_table table table-bordered table-hover" id="create_order_table">
				<thead>
					<tr>
						<th style="width:120px;">Ref No</th>
						<th style="width:400px;">Name</th>
						<th style="width:300px;">Description</th>
						<th style="width:150px;display:none;">Department</th-->
						<th style="width:180px;">Lot No / Expiry : Stocks</th>
						<th style="width:40px;">Action</th>
					</tr>
				</thead>
				{% if my_products %}
					{% for my_p in my_products %}
					<tr class="my_products_row">
						<td>{{ my_p.ref_number }}</td>
						<td>{{ my_p.name }}</td>
						<td>{{ my_p.description }}</td>
						<td class="dept_name" style="display:none">{{ my_p.dept }}</td>
						<td>{% for i in my_p.item_query %}
						<div id="{{ my_p.ref_number }}_lot_qty_{{ i.lot_num }}"><span style="font-weight: bold;color: blue;">{{ i.lot_num }}</span> / {% if i.greater_expiry %}<span style="font-style: italic;color: red;">{{ i.expiry.strftime('%d-%m-%Y') }}</span>{% else %}<span style="font-style: italic;color: blue;">{{ i.expiry.strftime('%d-%m-%Y') }}</span> {% endif %}: <span style="font-weight: bold;color: green;">{{ i.quantity }}</span></div>
						{% endfor %}</td>
						<td>{% if my_p.item_query %}<a href="{{ url_for('consume_item', company_name=company.company_name, ref_number=my_p.ref_number)}}">Consume</a>
						<a href="#" data-toggle="modal" data-target="#barcode_modal_{{ my_p.ref_number }}">Barcode</a>
						{% endif %}</td>
						
					</tr>
					
					{% endfor %}
				{% endif %}
			</table>
		</div>
		{% if my_products %}
		{% for my_p in my_products %}
		<div class="modal fade" id="barcode_modal_{{ my_p.ref_number }}" tabindex="-1" role="dialog" aria-labelledby="barcode_modal_{{ my_p.ref_number }}_label">
		  <div class="modal-dialog" role="document">
			<div class="modal-content">
			  <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<span class="text-center"><h4>Ref No: <span style="color: blue;">{{ my_p.ref_number }}</span></h4> </span>
				<span class="text-center"><h4>Name: <span style="color: blue;">{{ my_p.name }}</span></h4> </span>
			  </div>
			  <div class="modal-body">
				
				<select class="form-control" id="select_{{ my_p.ref_number }}">
					{% for i in my_p.item_query %}
					<option value="{{ i.lot_num }}{{ i.id }}">{{ i.lot_num }} - {{ i.id }} / {{ i.expiry.strftime('%d-%m-%Y') }}</option>
					
					{% endfor %}
				</select>
					<br>
					{% for i in my_p.item_query %}
					<div class="bcodes bcodes_{{ my_p.ref_number }} text-center" id="bc_container_{{ i.lot_num }}{{ i.id }}" style="text-align:center;margin:0 auto;">
						<svg  id="bc_{{ i.lot_num }}{{ i.id }}" style="margin: 0;">
						<p style="margin: 0;font-size:10px;">{{ i.lot_num }}-{{ i.id }} &nbsp&nbsp&nbsp Date received: {{ i.received_date.strftime('%d-%m-%Y') }}</p>
						<p style="margin: 0;font-size:10px;">{{ my_p.name }}</p>
						<!--p style="margin: 0;">Lot: {{ i.lot_num }} &nbsp&nbsp&nbsp Expiry: {{ i.expiry.strftime('%d-%m-%Y') }}</p-->
						<br>
						<p><input type="button" class="btn btn-default" id="print_{{ i.lot_num }}{{ i.id }}" value="Print"></p>
					</div>
					{% endfor %}
			  </div>
			</div>
		  </div>
		</div>
		{% endfor %}
		{% endif %}
	</div>
{% endblock %}

{% block scripts %}
	{{ super() }}
	<style id="print_barcode_media"></style>
	<script>
		$(document).ready(function() {
			$('input#search_create_orders').quicksearch('table#create_order_table .my_products_row');
			$('select#department').quicksearch('table#create_order_table .my_products_row');
			
			
			$('[id]').each(function () {
				{% for my_p in my_products %}{% for i in my_p.item_query %}
				$('[id="' + this.id + '"]:gt(0)').remove();
				{% endfor %}{% endfor %}
			});
			});
			
			{% if my_products %}
			{% for my_p in my_products %}
			{% for i in my_p.item_query %}
			$("#bc_{{ i.lot_num }}{{ i.id }}").JsBarcode("{{ i.lot_num }}-{{ i.id }}", {
				width: 2,
				height: 40,
				fontSize: 12,
				margin: 5,
				displayValue: false,
			});
			
			$('#select_{{ my_p.ref_number }}').change(function(){
				$('.bcodes_{{ my_p.ref_number }}').hide();
				$('#bc_container_' + $(this).val()).show();
			  });
			  
			$('#print_{{ i.lot_num }}{{ i.id }}').click(function(){
				$('#print_barcode_media').text(
					/*"@page {" +
						"size: 3in 1in;" +
						"margin: 0;" +
						"padding: 0;" +
					"}" +*/
					".page {" +
						"width: 3in;" +
						"height: 2in;" +
						"margin: 0;" +
					"}" +
					 ".bcodes_{{ my_p.ref_number }} {" +
						"width: 100%;" +
						"height: 100%;" +
						 "}" +
					"@media print {" + 
						"html, body {" + 
							"visibility: hidden;" +
							"width: 100%;" +
							"height: 100%;" +
							"margin: 0;" +
							"padding: 0;" +
							"}" + 
						"#bc_container_{{ i.lot_num }}{{ i.id }} {" +
							"visibility: visible;" +
							"margin-top: 0;" +
							"margin-bottom: 5px;" +
							"width: 100%;" +
							"height: 100%;" +
							"max-width: 100%;" +
							"max-height: 100%;" +
						"}" + 
						"#print_{{ i.lot_num }}{{ i.id }} {" +
							"visibility: hidden;" +
						"}" +
					"}"
				);
				/*$(document.html).css('visibility', 'hidden');
				$(document.body).css('visibility', 'hidden');
				$('#bc_container_{{ i.lot_num }}{{ i.id }}').css('visibility', 'visible', "width", "100%", "height", "100%", "max-width", "100%", "max-height", "100%");
				$('#print_{{ i.lot_num }}{{ i.id }}').css('visibility', 'hidden');*/
				window.print();
			});
			{% endfor %}
			{% endfor %}
			{% endif %}
			
			/*{% for my_p in my_products %}
				
				$("#request_{{ my_p.ref_number }}").click(function() {
					var qty_req = $("#quantity_request_{{ my_p.ref_number }}").html();
					
					var total = {{ my_p.price }} * qty_req;
					$("#total_price_{{ my_p.ref_number}}").html(total);
					$('input[name=qty]').val(qty_req);
					$('input[name=tot_price]').val(total);
					console.log(qty_req)
					console.log(total)
				});
				
				$("#submit").click(function() {
				$('#request_reagent_modal_{{ my_p.ref_number }}').modal('hide')		
			});
			{% endfor %}
			
			
		});*/
			
			/*{% for my_p in my_products %}
			
				$("#add_{{ my_p.ref_number }}").click(function() {
					var qty_req = $("#quantity_request_{{ my_p.ref_number }}").html();
					
					$('#orders_list_table > tbody:last-child').append("<tr><td>{{ my_p.ref_number}}</td><td>{{ my_p.name }}</td><td id='price_{{ my_p.ref_number}}'>{{ my_p.price }}</td><td id='qty_{{ my_p.ref_number}}'contenteditable></td><td class='individual_total' id='total_price_{{ my_p.ref_number}}'></td></tr>");
					
					
					$("#orders_list_form").append("<div><input type='hidden' name='refnum' value='{{ my_p.ref_number}}'><input type='hidden' name='name' value='{{ my_p.name }}'><input type='hidden' name='price' value='{{ my_p.price }}'><input type='hidden' name='qty' value=''><input type='hidden' name='tot_price' value=''></div>");
					
					var total = {{ my_p.price }} * qty_req;
					$("#qty_{{ my_p.ref_number}}").html(qty_req);
					$("#total_price_{{ my_p.ref_number}}").html(total);
					$('input[name=qty]').val(qty_req);
					$('input[name=tot_price]').val(total);
					
					var sum = 0;
					$(".individual_total").each(function() {
						sum += parseFloat($(this).text());
						$("#subtotal_price").html(sum);
					});
					if ($(".individual_total").length > 0) {
					$("#subtotal_container").css("display", "block");
					}
				});
				
			{% endfor %}*/
	
		
		/*{% for my_p in my_products %}
		$(document).on( 'keyup', '#quantity_request_{{ my_p.ref_number }}', function() {
		
			var edit_qty = $("#quantity_request_{{ my_p.ref_number }}").html();
			var edit_total = {{ my_p.price }} * edit_qty;
			
			$('input[name=qty]').val(edit_qty);
			$('input[name=tot_price]').val(edit_total);
		});
		{% endfor %}*/
		/*{% for my_p in my_products %}
		$(document).on( 'keyup', '#qty_{{ my_p.ref_number}}', function() {
			var edit_qty = $("#qty_{{ my_p.ref_number}}").html();
			var edit_total = {{ my_p.price }} * edit_qty;
			$("#total_price_{{ my_p.ref_number}}").html(edit_total);
			$('input[name=qty]').val(edit_qty);
			$('input[name=tot_price]').val(edit_total);
			var sum = 0;
			$(".individual_total").each(function() {
				sum += parseFloat($(this).text());
				$("#subtotal_price").html(sum);
			});
			if ($(".individual_total").length > 0) {
			$("#subtotal_container").css("display", "block");
			}
		});
		
		{% endfor %}*/
	
	</script>
{% endblock %}